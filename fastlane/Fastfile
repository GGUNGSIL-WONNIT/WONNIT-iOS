require 'dotenv'
Dotenv.load

default_platform(:ios)

def get_api_key
  app_store_connect_api_key(
    key_id: ENV["APP_STORE_CONNECT_KEY_ID"],
    issuer_id: ENV["APP_STORE_CONNECT_ISSUER_ID"],
    key_content: ENV["APP_STORE_CONNECT_API_KEY"],
    is_key_content_base64: true
  )
end

platform :ios do
  desc "Deploy to TestFlight Internal"
  lane :beta do
    sh("pod install")

    match(type: "appstore", api_key: get_api_key)

    build_app(
      workspace: "WONNIT.xcworkspace",
      scheme: "WONNIT",
      export_method: "app-store",
      include_bitcode: true,
      export_options: {
        signingStyle: "manual",
        provisioningProfiles: {
          "com.dohyeoplim.WONNIT" => "match AppStore com.dohyeoplim.WONNIT"
        }
      }
    )

    upload_to_testflight(
      api_key: get_api_key,
      distribute_external: false,
      skip_waiting_for_build_processing: true
    )
  end
end

