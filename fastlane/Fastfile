default_platform(:ios)

def get_api_key
  app_store_connect_api_key(
    key_id: ENV["APP_STORE_CONNECT_KEY_ID"],
    issuer_id: ENV["APP_STORE_CONNECT_ISSUER_ID"],
    key_content: ENV["APP_STORE_CONNECT_API_KEY"],
    is_key_content_base64: true
  )
end

platform :ios do
  desc "Deploy to TestFlight Internal"
  lane :beta do
    sh("pod install")

    keychain_name = "fastlane_tmp_keychain"
    keychain_password = ENV["MATCH_PASSWORD"]

    match(
      type: "appstore",
      api_key: get_api_key,
      keychain_name: keychain_name,
      keychain_password: keychain_password
    )

    unlock_keychain(
      name: keychain_name,
      password: keychain_password
    )

    build_app(
      workspace: "WONNIT.xcworkspace",
      scheme: "WONNIT",
      export_method: "app-store",
      include_bitcode: true,
      export_options: {
        signingStyle: "manual",
        provisioningProfiles: {
          "com.dohyeoplim.WONNIT" => "match AppStore com.dohyeoplim.WONNIT"
        }
      }
    )

   upload_to_testflight(api_key: get_api_key)
  end
end

